<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>weForth: weForth - Web eForth with WASM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">weForth
   &#160;<span id="projectnumber">v1.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">weForth - Web eForth with WASM </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>WebAssembly enpowered eForth on web browsers. Is it faster? Is it more portable? Yes, and Yes.</p>
<p>Well, on my aged laptop, the impression is pretty exciting! It's at least 5x faster than pure Javascript implementation on a browser and at 1/2 speed of C/C++ natively compiled code on CPU. It was at 1/4 of native a year ago but as Javascript JIT improves, it now runs faster as well. Not bad at all! On the portability end, though not exactly plug-and-play but some simple alteration turned my C code web-enabled. Of course, WASM has yet to integrate with the front-end well enough, so updating DOM is a different feat if we want to venture beyond being a terminal app.</p>
<p>Regardless, it brought me warm smiles seeing eForth run in a browser. Better yet, it's straight from C/C++ source code. Other popular scripting languages such as Python, Ruby are trending toward WASM/WASI implementation as well. However, depending solely on JIT without built-in compiler as Forth does, the interpreter-in-an-interpreter design will likely cap the top-end performance (i.e. stuck at 1/5~1/10 of native, so far).</p>
<p>With WASM, the interoperability between different languages become a thing of the near future. If Forth can compile word directly into WASM opcodes, engage WASI to access OS and peripherals, hookup the graphic front-end (i.g. SDL or WebGL), weForth can become a worthy scripting alternative for Web.</p>
<h2>Features</h2>
<ul>
<li>Forth in Web Worker threads (multi-VMs possible)</li>
<li>Javascript access to ss, dict, and VM memory (via WebAssembly.Memory)</li>
<li>Javascript function calling interface</li>
<li>IDE-style interactive front-end (cloud possible, i.g. JupyterLab)</li>
</ul>
<blockquote class="doxtable">
<p><a href="https://chochain.github.io/weForth/img/weforth_logo_snip2.png" style="width:800px">sample</a> </p>
</blockquote>
<h2>Build - (make sure python3 and Emscripten are installed)</h2>
<h3>Bare-bone eForth on Web</h3>
<pre class="fragment">make zero
Note: -O2 works OK, -O3 emscripten spits wrong code
</pre><p>try eforth.html <a href="https://chochain.github.io/weForth/ref/eforth.html">here</a></p>
<h3>Single WASM file</h3>
<pre class="fragment">make one
</pre><p>try ceforth.html <a href="https://chochain.github.io/weForth/ref/ceforth.html">here</a></p>
<h3>Extra Web Worker thread</h3>
<pre class="fragment">make two
</pre><p>try weforth.html <a href="https://chochain.github.io/weForth/ref/weforth.html">here</a></p>
<h2>Run on your own box</h2>
<p>Server-side </p><pre class="fragment">python3 -m http.server
</pre><p>Client-side Browser </p><pre class="fragment">http://localhost:8000/tests/eforth.html, ceforth.html or weforth.html
</pre><h2>Javascript interface</h2>
<p>To communicate between Forth and Javascript engine, weForth implemented a word 'JS' and a function call_js(). They utilize Emscripten EM_JS macro that <em>postMessage</em> from C++ backend-side to <em>onmessage</em> on browser-side. Depends on your need, handler can be very simple to complicated.</p>
<h3>ceforth.html - a very simple (and dangerous) handler</h3>
<pre class="fragment">this.onmessage = e=&gt;{
    if (e.data[0]=='js') this.eval(e.data[1])
}

&gt; 54321 s" alert('%d ... hello world!')" JS⏎
</pre><blockquote class="doxtable">
<p><a href="https://chochain.github.io/weForth/img/weforth_js.png" width="604px">JS call</a> </p>
</blockquote>
<h3>weforth.html - a more complex handler</h3>
<pre class="fragment">const ex = (ops)=&gt;Function(       ///&lt; scope limiting eval
    `"use strict"; this.update('${ops}')`
).bind(logo)()
vm.onmessage = e=&gt;{               /// * wait for worker's response
    let k = e.data[0], v = e.data[1]
    switch (k) {
    case 'cmd': to_txt(v);         break
    case 'dc' : show_dict(v);      break
    case 'us' : usr.innerHTML = v; break
    case 'ss' : ss.innerHTML  = v; break
    case 'mm' : mm.innerHTML  = v; ok=1; break
    case 'js' : ex(v);             break
    default: console.log('onmessage.error=&gt;'+e)
    }
}

&gt; s" forth/logo.fs" included⏎
&gt; : seg FD 30 RT ;⏎
&gt; : color 2* PC ;⏎
&gt; : daz 100 0 do i color i seg loop ;⏎
&gt; daz⏎
</pre><blockquote class="doxtable">
<p><a href="https://chochain.github.io/weForth/img/weforth_logo.png" width="604px">Logo demo</a> </p>
</blockquote>
<h2>DEBUG the WASM file (dump all functions, check with wasm-objdump in WABT kit)</h2>
<pre class="fragment">make debug
read tests/ceforth.wasm.txt (really long)
</pre><h2>Benchmark (on my aged IBM X230 w Intel <a href="#" onclick="location.href='mai'+'lto:'+'i5-'+'34'+'70@'+'3.'+'2GH'+'z'; return false;">i5-34<span style="display: none;">.nosp@m.</span>70@3<span style="display: none;">.nosp@m.</span>.2GHz</a>)</h2>
<p>Simple 10M tests </p><pre class="fragment">: xx 9999 FOR 34 DROP NEXT ;⏎
: yy 999 FOR xx NEXT ;⏎
: zz MS NEGATE yy MS + ;⏎
zz⏎
</pre><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">implementation </th><th class="markdownTableHeadNone">version </th><th class="markdownTableHeadNone">source code </th><th class="markdownTableHeadNone">optimization </th><th class="markdownTableHeadNone">platform </th><th class="markdownTableHeadNone">run time(ms) </th><th class="markdownTableHeadNone">code size(KB)  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">eforth </td><td class="markdownTableBodyNone">4.2 </td><td class="markdownTableBodyNone">g++ / C </td><td class="markdownTableBodyNone">-O0 </td><td class="markdownTableBodyNone">CPU </td><td class="markdownTableBodyNone">1830 </td><td class="markdownTableBodyNone">186  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O2 </td><td class="markdownTableBodyNone">CPU </td><td class="markdownTableBodyNone">85 </td><td class="markdownTableBodyNone">106  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O3 </td><td class="markdownTableBodyNone">CPU </td><td class="markdownTableBodyNone">87 </td><td class="markdownTableBodyNone">114  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">eforth </td><td class="markdownTableBodyNone">4.2 </td><td class="markdownTableBodyNone">EM.b / C </td><td class="markdownTableBodyNone">-O0 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">4250 </td><td class="markdownTableBodyNone">273  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O2 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">215 </td><td class="markdownTableBodyNone">160  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O3 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">222 </td><td class="markdownTableBodyNone">176  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">eForth.js </td><td class="markdownTableBodyNone">pre6 </td><td class="markdownTableBodyNone">JavaScript </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">FF.a </td><td class="markdownTableBodyNone">756 </td><td class="markdownTableBodyNone">20  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">pre6 </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">1059 </td><td class="markdownTableBodyNone">20  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">4.2 </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">1459 </td><td class="markdownTableBodyNone">20  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uEforth </td><td class="markdownTableBodyNone">7.0.2 </td><td class="markdownTableBodyNone">Asm.js </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">FF.a </td><td class="markdownTableBodyNone">814 </td><td class="markdownTableBodyNone">29  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">7.0.7 </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">387 </td><td class="markdownTableBodyNone">29  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">weForth </td><td class="markdownTableBodyNone">1.2 </td><td class="markdownTableBodyNone">EM.a / C </td><td class="markdownTableBodyNone">-O0 </td><td class="markdownTableBodyNone">FF.a1 </td><td class="markdownTableBodyNone">943 </td><td class="markdownTableBodyNone">254  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O2 </td><td class="markdownTableBodyNone">FF.a1 </td><td class="markdownTableBodyNone">410 </td><td class="markdownTableBodyNone">165  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">weForth </td><td class="markdownTableBodyNone">1.4 </td><td class="markdownTableBodyNone">EM.b / C </td><td class="markdownTableBodyNone">-O0 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">451 </td><td class="markdownTableBodyNone">267  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O2 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">181 </td><td class="markdownTableBodyNone">170  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">weForth </td><td class="markdownTableBodyNone">4.1 </td><td class="markdownTableBodyNone">EM.b / C </td><td class="markdownTableBodyNone">-O0 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">348 </td><td class="markdownTableBodyNone">300  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O2 </td><td class="markdownTableBodyNone">FF.b </td><td class="markdownTableBodyNone">154 </td><td class="markdownTableBodyNone">164  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">-O2 </td><td class="markdownTableBodyNone">FF.b1 </td><td class="markdownTableBodyNone">160 </td><td class="markdownTableBodyNone">164  </td></tr>
</table>
<pre class="fragment">FF.a = FireFox v120, FF.a1 = FF.a + 1 worker
FF.b = FireFox v122, FF.b1 = FF.b + 1 worker
EM.a = Emscripten v3.1.51
EM.b = Emscripten v3.1.53

Note1: eForth.js uses JS straight, can do floating-points
Note2: uEforth v7 uses Asm.js, build Forth up with JS "assembly".
Note3: weForth v1 uses token indirected threaded
Note4: weForth+switch(op), is 2x slower than just function pointers.
Note5: weForth v1.2 without yield in nest() speeds up 3x.
Note6: WASM -O3 =&gt; err functions (wa.*) not found
Note7: FireFox v122 is vastly faster than v120
Note8: Chrome is about 10% slower than FireFox
</pre><h2>TODO</h2>
<ul>
<li>review wasmtime (CLI), perf+hotspot (profiling)</li>
<li>review DragonRuby/mRuby (SDL)</li>
<li>review R3, Forth CPU visualizer (SDL)</li>
<li>GraFORTH spec.<ul>
<li>File system (FS/IndexedDB)</li>
<li>Editor</li>
<li>2D graphic (SDL_gfx, SDL_image)</li>
<li>Character graphic (SDL_ttf or HTML5)</li>
<li>3D graphic (GL)</li>
<li>Music (SDL_media)</li>
</ul>
</li>
<li>Robotic Simulation Engine<ul>
<li>review raylib</li>
<li>review Three.js</li>
<li>CSG Object (with optional motion trail) <a href="https://opencsg.org/">OpenCSG</a>, <a href="https://gts.sourceforge.net/">GTS</a></li>
<li>Collision (with directional distance sensing)</li>
</ul>
</li>
<li>add network system (SD_net)</li>
<li>inter-VM communication</li>
<li>use WASM stack as ss</li>
<li>macro-assembler</li>
</ul>
<h2>References</h2>
<ul>
<li>SDL2<ul>
<li>Read first <a href="https://lyceum-allotments.github.io/2016/06/emscripten-and-sdl-2-tutorial-part-1/">https://lyceum-allotments.github.io/2016/06/emscripten-and-sdl-2-tutorial-part-1/</a></li>
<li>LazyFoo for SDL2 <a href="https://lazyfoo.net/tutorials/SDL/">https://lazyfoo.net/tutorials/SDL/</a></li>
<li>raylib vs SDL2 <a href="https://gist.github.com/raysan5/17392498d40e2cb281f5d09c0a4bf798">https://gist.github.com/raysan5/17392498d40e2cb281f5d09c0a4bf798</a> </li>
</ul>
</li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
