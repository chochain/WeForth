<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>weForth: weForth - Web eForth with WASM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">weForth
   &#160;<span id="projectnumber">v4.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">weForth - Web eForth with WASM </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>WebAssembly enpowered eForth on web browsers. Is it faster? Is it more portable? Yes, and Yes.</p>
<p><img src="https://chochain.github.io/weForth/img/weforth_jolt2.png" alt="" style="width:800px" class="inline"/></p>
<p>Well, on my aged laptop, the impression is pretty exciting! It's at least 5x faster than pure Javascript implementation on a browser and at 60% speed of C/C++ natively compiled code on CPU. It was at 25% of native a year ago but as Javascript JIT improves, it now runs faster as well. Not bad at all! On the portability end, though not exactly plug-and-play but some simple alteration turned my C code web-enabled. Of course, WASM has yet to integrate with the front-end well enough, so updating DOM is a different feat. If we want to venture beyond being a terminal app some UI glue is still required.</p>
<p>Regardless, it brought me warm smiles seeing eForth run in a browser. Better yet, it's straight from C/C++ source code. Other popular scripting languages such as Python, Ruby are trending toward WASM/WASI implementation as well. However, unlike FORTH, they depend mostly on JIT without a built-in compiler, the interpreter-in-an-interpreter design will likely cap the top-end performance (i.e. stuck at 10~15% of native speed, so far).</p>
<p>With WASM, the interoperability between different languages become a thing of the near future. If words can be compiled directly into WASM opcodes, OS and peripherals can be accessed through WASI, adding an interactive graphical front-end, weForth can become a worthy scripting alternative for Web.</p>
<h2>Features</h2>
<ul>
<li>supports 32-bit float</li>
<li>call interface from FORTH into Javascript functions</li>
<li>integrated with Web graphics (SDL2, WebGL) and Physics Engine (Jolt)</li>
<li>built-in editor, IDE-style interactive front-end</li>
<li>access to ss, dict, and VM memory (via WebAssembly.Memory) from Javascript</li>
<li>browser can fetch from self-host web server (i.g. python3 -m http.server)</li>
<li>can run parallel in Web Worker threads</li>
</ul>
<p><img src="https://chochain.github.io/weForth/img/weforth_logo_snip2.png" alt="" style="width:800px" class="inline"/></p>
<h2>Build - (make sure python3 and Emscripten are installed)</h2>
<h3>Templates</h3>
<p>Serving as the core of demos, the templates under ~/template directory are used in different built shown below. They are organized by the Makefile</p><ul>
<li>eforth.html - vanilla weForth, one single-threaded HTML. A good place to start.</li>
<li>ceforth.html - weForth, now with integrated editor, single-threaded.</li>
<li><p class="startli">weforth.html - weForth runs in a worker thread, can also do fancy GUI stuffs now Javascript module/files are included in the HTML for added functionality </p><pre>
       + weforth_helper.js - vocabulary lookup table
       + weforth_worker.js - worker thread proxy object
       + weforth_sleep.js  - sleep/delay support for async environment
       + weforth_logo.js   - Turtle Graphic implementation
       + weforth_jolt.js   - Jolt Physics Engine integration
       + file_io.js        - file IO support
       </pre><p class="startli">The following Forth scripts under ~/tests/forth are also included for GUI integration demo </p><pre>
       + forth/logo.fs - Turtle Graphics
       + forth/jolt.fs - Jolt Physics Engine
       </pre></li>
</ul>
<p>#</p><h2>Bare-bone eForth on Web</h2>
<pre class="fragment">make zero
Note: -O2 works OK, -O3 emscripten spits wrong code
</pre><p>try eforth.html <a href="https://chochain.github.io/weForth/ref/eforth.html">here</a></p>
<h3>Single WASM file</h3>
<pre class="fragment">make one
</pre><p>try ceforth.html <a href="https://chochain.github.io/weForth/ref/ceforth.html">here</a></p>
<h3>Extra Web Worker thread</h3>
<pre class="fragment">make two
</pre><p>try weforth.html <a href="https://chochain.github.io/weForth/ref/weforth.html">here</a></p>
<h2>Run on your own box</h2>
<p>Server-side </p><pre class="fragment">python3 -m http.server
</pre><p>Client-side Browser </p><pre class="fragment">http://localhost:8000/tests/eforth.html, ceforth.html or weforth.html
</pre><h2>Javascript interface</h2>
<p>To communicate between Forth and Javascript engine, weForth implemented a word 'JS' and a function call_js(). They utilize Emscripten EM_JS macro that <em>postMessage</em> from C++ backend-side to <em>onmessage</em> on browser-side. Depends on your need, handler can be very simple to complicated.</p>
<h3>in eforth.html and ceforth.html - a simple (and dangerous) handler with the single-threaded demo</h3>
<pre class="fragment">this.onmessage = e=&gt;{
    if (e.data[0]=='js') this.eval(e.data[1])
}

&gt; 54321 s" alert('%d ... hello world!')" JS⏎
</pre><p><img src="https://chochain.github.io/weForth/img/weforth_js.png" alt="" width="604px" class="inline"/></p>
<h3>weforth.html - a more complex message dispatcher with the multi-threaded web worker demo</h3>
<pre class="fragment">const ex = (ops)=&gt;Function(       ///&lt; scope limiting eval
    `"use strict"; this.update('${ops}')`
).bind(logo)()
vm.onmessage = e=&gt;{               /// * wait for worker's response
    let k = e.data[0], v = e.data[1]
    switch (k) {
    case 'cmd': to_txt(v);         break
    case 'dc' : show_dict(v);      break
    case 'us' : usr.innerHTML = v; break
    case 'ss' : ss.innerHTML  = v; break
    case 'mm' : mm.innerHTML  = v; ok=1; break
    case 'js' : ex(v);             break
    default: console.log('onmessage.error=&gt;'+e)
    }
}

&gt; s" forth/logo.fs" included⏎
&gt; : seg FD 30 RT ;⏎
&gt; : color 2* PC ;⏎
&gt; : daz 100 0 do i color i seg loop ;⏎
&gt; daz⏎
</pre><p><img src="https://chochain.github.io/weForth/img/weforth_logo.png" alt="" width="604px" class="inline"/></p>
<h2>DEBUG the WASM file (dump all functions, check with wasm-objdump in WABT kit)</h2>
<pre class="fragment">make debug
read tests/ceforth.wasm.txt (really long)
</pre><h2>Benchmark (on my aged IBM X230 w Intel <a href="#" onclick="location.href='mai'+'lto:'+'i5-'+'34'+'70@'+'3.'+'2GH'+'z'; return false;">i5-34<span style="display: none;">.nosp@m.</span>70@3<span style="display: none;">.nosp@m.</span>.2GHz</a>)</h2>
<p>Simple 10M tests </p><pre class="fragment">: xx 9999 FOR 34 DROP NEXT ;⏎
: yy 999 FOR xx NEXT ;⏎
: zz MS NEGATE yy MS + ;⏎
zz⏎
</pre><p><img src="https://chochain.github.io/weForth/img/weforth_perf.png" alt="" width="800px" class="inline"/></p>
<p>Note:</p><ul>
<li>eForth.js uses JS straight, can do floating-points</li>
<li>uEforth v7 uses Asm.js, build Forth up with JS "assembly".</li>
<li>weForth v1 uses token indirected threaded</li>
<li>weForth+switch(op), is 2x slower than just function pointers.</li>
<li>weForth v1.2 without yield in <a class="el" href="ceforth_8cpp.html#aa6e8df9fa2337499c3b66a5446ec4f77">nest()</a>, speeds up 3x.</li>
<li>WASM -O3 =&gt; err functions (wa.*) not found</li>
<li>FireFox v122, is 2x faster than v120</li>
<li>Chrome is about 10% slower than FireFox</li>
<li>weForth 4.2 w float32-enabled, runs faster than int32, but why?</li>
<li>weForth 4.2 w float32/real-time is slower due to message passing</li>
<li>weForth 4.2 w float32/real-time is even slower without WebGL, why?</li>
</ul>
<h2>TODO</h2>
<ul>
<li>Physics Engine<ul>
<li>keyboard control</li>
<li>vehicle sim</li>
</ul>
</li>
<li>inter-VM communication</li>
<li>add network system (SD_net)</li>
<li>review WebSerial</li>
<li>review wasmtime (CLI), perf+hotspot (profiling)</li>
<li>review DragonRuby/mRuby (SDL)</li>
<li>review R3, Forth CPU visualizer (SDL)</li>
<li>review GraFORTH spec.<ul>
<li>File system (FS/IndexedDB)</li>
<li>Editor</li>
<li>2D graphic (SDL_gfx, SDL_image)</li>
<li>Character graphic (SDL_ttf or HTML5)</li>
<li>3D graphic (GL)</li>
<li>Music (SDL_media)</li>
</ul>
</li>
<li>use WASM stack as ss</li>
<li>macro-assembler</li>
</ul>
<h2>References</h2>
<ul>
<li>SDL2<ul>
<li><a href="https://lyceum-allotments.github.io/2016/06/emscripten-and-sdl-2-tutorial-part-1/">Read first</a></li>
<li><a href="https://lazyfoo.net/tutorials/SDL/">LazyFoo for SDL2</a></li>
<li><a href="https://gist.github.com/raysan5/17392498d40e2cb281f5d09c0a4bf798">raylib vs SDL2</a></li>
</ul>
</li>
<li>Physics Engine<ul>
<li><a href="https://jrouwe.github.io/JoltPhysics/">Jolt Physics</a><ul>
<li>CSG Object (with optional motion trail) <a href="https://opencsg.org/">OpenCSG</a>, <a href="https://gts.sourceforge.net/">GTS</a> </li>
</ul>
</li>
</ul>
</li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
