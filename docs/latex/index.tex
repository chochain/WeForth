Web\+Assembly enpowered e\+Forth on web browsers. Is it faster? Is it more portable? Yes, and Yes.



Well, on my aged laptop, the impression is pretty exciting! It\textquotesingle{}s at least 5x faster than pure Javascript implementation on a browser and at 40\% speed of C/\+C++ natively compiled code on C\+PU. It was at 25\% of native a year ago but as Javascript J\+IT improves, it now runs faster as well. Not bad at all! On the portability end, though not exactly plug-\/and-\/play but some simple alteration turned my C code web-\/enabled. Of course, W\+A\+SM has yet to integrate with the front-\/end well enough, so updating D\+OM is a different feat. If we want to venture beyond being a terminal app some UI glue is still required.

Regardless, it brought me warm smiles seeing e\+Forth run in a browser. Better yet, it\textquotesingle{}s straight from C/\+C++ source code. Other popular scripting languages such as Python, Ruby are trending toward W\+A\+S\+M/\+W\+A\+SI implementation as well. However, unlike F\+O\+R\+TH, they depend mostly on J\+IT without a built-\/in compiler, the interpreter-\/in-\/an-\/interpreter design will likely cap the top-\/end performance (i.\+e. stuck at 5$\sim$10\% of native speed, so far).

With W\+A\+SM, the interoperability between different languages become a thing of the near future. If words can be compiled directly into W\+A\+SM opcodes, OS and peripherals can be accessed through W\+A\+SI, adding a graphic front-\/end (i.\+g. S\+DL or Web\+GL), we\+Forth can become a worthy scripting alternative for Web.

\doxysubsection*{Features}


\begin{DoxyItemize}
\item supports 32-\/bit float
\item call interface from F\+O\+R\+TH into Javascript functions
\item integrated with Web graphics (S\+D\+L2, Web\+GL) and Physics Engine (Jolt)
\item built-\/in editor, I\+D\+E-\/style interactive front-\/end
\item access to ss, dict, and VM memory (via Web\+Assembly.\+Memory) from Javascript
\item can run parallel in Web Worker threads


\end{DoxyItemize}

\doxysubsection*{Build -\/ (make sure python3 and Emscripten are installed)}

\doxysubsubsection*{Templates}

Serving as the core of demos, the templates under $\sim$/template directory are used in different built shown below. They are organized by the Makefile
\begin{DoxyItemize}
\item eforth.\+html -\/ vanilla we\+Forth, one single-\/threaded H\+T\+ML. A good place to start.
\item ceforth.\+html -\/ we\+Forth, now with integrated editor, single-\/threaded.
\item weforth.\+html -\/ we\+Forth runs in a worker thread, can also do fancy G\+UI stuffs now $>$ Javascript module/files are included in the H\+T\+ML for added functionality $>$ + weforth\+\_\+helper.\+js -\/ vocabulary lookup table $>$ + weforth\+\_\+worker.\+js -\/ worker thread proxy object $>$ + weforth\+\_\+sleep.\+js -\/ sleep/delay support for async environment $>$ + weforth\+\_\+logo.\+js -\/ Turtle Graphic implementation $>$ + weforth\+\_\+jolt.\+js -\/ Jolt Physics Engine integration $>$ + file\+\_\+io.\+js -\/ file IO support

$>$ The following Forth scripts under $\sim$/tests/forth are also included for G\+UI integration demo $>$ + forth/logo.\+fs -\/ Turtle Graphics $>$ + forth/jolt.\+fs -\/ Jolt Physics Engine
\end{DoxyItemize}

\doxysubsubsection*{Bare-\/bone e\+Forth on Web}

\begin{DoxyVerb}make zero
Note: -O2 works OK, -O3 emscripten spits wrong code
\end{DoxyVerb}


try eforth.\+html \href{https://chochain.github.io/weForth/ref/eforth.html}{\texttt{ here}}

\doxysubsubsection*{Single W\+A\+SM file}

\begin{DoxyVerb}make one
\end{DoxyVerb}


try ceforth.\+html \href{https://chochain.github.io/weForth/ref/ceforth.html}{\texttt{ here}}

\doxysubsubsection*{Extra Web Worker thread}

\begin{DoxyVerb}make two
\end{DoxyVerb}


try weforth.\+html \href{https://chochain.github.io/weForth/ref/weforth.html}{\texttt{ here}}

\doxysubsection*{Run on your own box}

Server-\/side \begin{DoxyVerb}python3 -m http.server
\end{DoxyVerb}


Client-\/side Browser \begin{DoxyVerb}http://localhost:8000/tests/eforth.html, ceforth.html or weforth.html
\end{DoxyVerb}


\doxysubsection*{Javascript interface}

To communicate between Forth and Javascript engine, we\+Forth implemented a word \textquotesingle{}JS\textquotesingle{} and a function call\+\_\+js(). They utilize Emscripten E\+M\+\_\+\+JS macro that {\itshape post\+Message} from C++ backend-\/side to {\itshape onmessage} on browser-\/side. Depends on your need, handler can be very simple to complicated.

\doxysubsubsection*{in eforth.\+html and ceforth.\+html -\/ a simple (and dangerous) handler with the single-\/threaded demo}

\begin{DoxyVerb}this.onmessage = e=>{
    if (e.data[0]=='js') this.eval(e.data[1])
}

> 54321 s" alert('%d ... hello world!')" JS⏎
\end{DoxyVerb}


\begin{quote}
JS call \end{quote}


\doxysubsubsection*{weforth.\+html -\/ a more complex message dispatcher with the multi-\/threaded web worker demo}

\begin{DoxyVerb}const ex = (ops)=>Function(       ///< scope limiting eval
    `"use strict"; this.update('${ops}')`
).bind(logo)()
vm.onmessage = e=>{               /// * wait for worker's response
    let k = e.data[0], v = e.data[1]
    switch (k) {
    case 'cmd': to_txt(v);         break
    case 'dc' : show_dict(v);      break
    case 'us' : usr.innerHTML = v; break
    case 'ss' : ss.innerHTML  = v; break
    case 'mm' : mm.innerHTML  = v; ok=1; break
    case 'js' : ex(v);             break
    default: console.log('onmessage.error=>'+e)
    }
}

> s" forth/logo.fs" included⏎
> : seg FD 30 RT ;⏎
> : color 2* PC ;⏎
> : daz 100 0 do i color i seg loop ;⏎
> daz⏎
\end{DoxyVerb}


\begin{quote}
Logo demo \end{quote}


\doxysubsection*{D\+E\+B\+UG the W\+A\+SM file (dump all functions, check with wasm-\/objdump in W\+A\+BT kit)}

\begin{DoxyVerb}make debug
read tests/ceforth.wasm.txt (really long)
\end{DoxyVerb}


\doxysubsection*{Benchmark (on my aged I\+BM X230 w Intel \href{mailto:i5-3470@3.2GHz}{\texttt{ i5-\/3470@3.\+2\+G\+Hz}})}

Simple 10M tests \begin{DoxyVerb}: xx 9999 FOR 34 DROP NEXT ;⏎
: yy 999 FOR xx NEXT ;⏎
: zz MS NEGATE yy MS + ;⏎
zz⏎
\end{DoxyVerb}


\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{7}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ implementation }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ version }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ source code }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ optimization }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ platform }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ run time(ms) }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ code size(\+K\+B)  }\\\cline{1-7}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ implementation }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ version }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ source code }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ optimization }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ platform }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ run time(ms) }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ code size(\+K\+B)  }\\\cline{1-7}
\endhead
eforth &4.\+2 &g++ / C &-\/O0 &C\+PU &1830 &186  \\\cline{1-7}
&&&-\/O2 &C\+PU &85 &106  \\\cline{1-7}
&&&-\/O3 &C\+PU &87 &114  \\\cline{1-7}
eforth &4.\+2 &E\+M.\+b / C &-\/O0 &F\+F.\+b &4250 &273  \\\cline{1-7}
&&&-\/O2 &F\+F.\+b &215 &160  \\\cline{1-7}
&&&-\/O3 &F\+F.\+b &222 &176  \\\cline{1-7}
e\+Forth.\+js &pre6 &Java\+Script &&F\+F.\+a &756 &20  \\\cline{1-7}
&pre6 &&&F\+F.\+b &1059 &20  \\\cline{1-7}
&4.\+2 &&&F\+F.\+b &1459 &20  \\\cline{1-7}
u\+Eforth &7.\+0.\+2 &Asm.\+js &&F\+F.\+a &814 &29  \\\cline{1-7}
&7.\+0.\+7 &&&F\+F.\+b &387 &29  \\\cline{1-7}
we\+Forth &1.\+2 &E\+M.\+a / C &-\/O0 &F\+F.\+a1 &943 &254  \\\cline{1-7}
&&&-\/O2 &F\+F.\+a1 &410 &165  \\\cline{1-7}
we\+Forth &1.\+4 &E\+M.\+b / C &-\/O0 &F\+F.\+b &451 &267  \\\cline{1-7}
&&&-\/O2 &F\+F.\+b &181 &170  \\\cline{1-7}
we\+Forth &4.\+1 &E\+M.\+b / C &-\/O0 &F\+F.\+b &348 &300  \\\cline{1-7}
&&&-\/O2 &F\+F.\+b &154 &164  \\\cline{1-7}
&&&-\/O2 &F\+F.\+b1 &160 &164  \\\cline{1-7}
we\+Forth~\newline
float32 &4.\+2 &E\+M.\+b / C &-\/O2 &F\+F.\+b &160 &153  \\\cline{1-7}
\end{longtabu}
\begin{DoxyVerb}FF.a = FireFox v120, FF.a1 = FF.a + 1 worker
FF.b = FireFox v122, FF.b1 = FF.b + 1 worker
EM.a = Emscripten v3.1.51
EM.b = Emscripten v3.1.53
\end{DoxyVerb}


Note\+:
\begin{DoxyItemize}
\item e\+Forth.\+js uses JS straight, can do floating-\/points
\item u\+Eforth v7 uses Asm.\+js, build Forth up with JS \char`\"{}assembly\char`\"{}.
\item we\+Forth v1 uses token indirected threaded
\item we\+Forth+switch(op), is 2x slower than just function pointers.
\item we\+Forth v1.\+2 without yield in \mbox{\hyperlink{ceforth_8cpp_aa6e8df9fa2337499c3b66a5446ec4f77}{nest()}}, speeds up 3x.
\item W\+A\+SM -\/O3 =$>$ err functions (wa.$\ast$) not found
\item Fire\+Fox v122, is 2x faster than v120
\item Chrome is about 10\% slower than Fire\+Fox
\item we\+Forth 4.\+2 w float32-\/enabled, runs equally fast as int32, but why?
\end{DoxyItemize}

\doxysubsection*{T\+O\+DO}


\begin{DoxyItemize}
\item Physics Engine
\begin{DoxyItemize}
\item keyboard control
\item vehicle sim
\end{DoxyItemize}
\item inter-\/\+VM communication
\item add network system (S\+D\+\_\+net)
\item review Web\+Serial
\item review wasmtime (C\+LI), perf+hotspot (profiling)
\item review Dragon\+Ruby/m\+Ruby (S\+DL)
\item review R3, Forth C\+PU visualizer (S\+DL)
\item review Gra\+F\+O\+R\+TH spec.
\begin{DoxyItemize}
\item File system (F\+S/\+Indexed\+DB)
\item Editor
\item 2D graphic (S\+D\+L\+\_\+gfx, S\+D\+L\+\_\+image)
\item Character graphic (S\+D\+L\+\_\+ttf or H\+T\+M\+L5)
\item 3D graphic (GL)
\item Music (S\+D\+L\+\_\+media)
\end{DoxyItemize}
\item use W\+A\+SM stack as ss
\item macro-\/assembler
\end{DoxyItemize}

\doxysubsection*{References}


\begin{DoxyItemize}
\item S\+D\+L2
\begin{DoxyItemize}
\item \href{https://lyceum-allotments.github.io/2016/06/emscripten-and-sdl-2-tutorial-part-1/}{\texttt{ Read first}}
\item \href{https://lazyfoo.net/tutorials/SDL/}{\texttt{ Lazy\+Foo for S\+D\+L2}}
\item \href{https://gist.github.com/raysan5/17392498d40e2cb281f5d09c0a4bf798}{\texttt{ raylib vs S\+D\+L2}}
\end{DoxyItemize}
\item Physics Engine
\begin{DoxyItemize}
\item \href{https://jrouwe.github.io/JoltPhysics/}{\texttt{ Jolt Physics}}
\begin{DoxyItemize}
\item C\+SG Object (with optional motion trail) \href{https://opencsg.org/}{\texttt{ Open\+C\+SG}}, \href{https://gts.sourceforge.net/}{\texttt{ G\+TS}} 
\end{DoxyItemize}
\end{DoxyItemize}
\end{DoxyItemize}