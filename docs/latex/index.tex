Web\+Assembly enpowered e\+Forth on web browsers. Is it faster? Is it more portable? Yes, and Yes.



Well, on my aged laptop, the impression is pretty exciting! It\textquotesingle{}s at least 5x faster than pure Javascript implementation on a browser and at 60\% speed of C/\+C++ natively compiled code on C\+PU. It was at 25\% of native a year ago but as Javascript J\+IT improves, it now runs faster as well. Not bad at all! On the portability end, though not exactly plug-\/and-\/play but some simple alteration turned my C code web-\/enabled. Of course, W\+A\+SM has yet to integrate with the front-\/end well enough, so updating D\+OM is a different feat. If we want to venture beyond being a terminal app some UI glue is still required.

Regardless, it brought me warm smiles seeing e\+Forth run in a browser. Better yet, it\textquotesingle{}s straight from C/\+C++ source code. Other popular scripting languages such as Python, Ruby are trending toward W\+A\+S\+M/\+W\+A\+SI implementation as well. However, unlike F\+O\+R\+TH, they depend mostly on J\+IT without a built-\/in compiler, the interpreter-\/in-\/an-\/interpreter design will likely cap the top-\/end performance (i.\+e. stuck at 10$\sim$15\% of native speed, so far).

With W\+A\+SM, the interoperability between different languages become a thing of the near future. If words can be compiled directly into W\+A\+SM opcodes, OS and peripherals can be accessed through W\+A\+SI, adding an interactive graphical front-\/end, we\+Forth can become a worthy scripting alternative for Web.

\doxysubsection*{Features}


\begin{DoxyItemize}
\item supports 32-\/bit float
\item call interface from F\+O\+R\+TH into Javascript functions
\item integrated with Web graphics (S\+D\+L2, Web\+GL) and Physics Engine (Jolt)
\item built-\/in editor, I\+D\+E-\/style interactive front-\/end
\item access to ss, dict, and VM memory (via Web\+Assembly.\+Memory) from Javascript
\item browser can fetch from self-\/host web server (i.\+g. python3 -\/m http.\+server)
\item can run parallel in Web Worker threads
\end{DoxyItemize}



\doxysubsection*{Build -\/ (make sure python3 and Emscripten are installed)}

\doxysubsubsection*{Templates}

Serving as the core of demos, the templates under $\sim$/template directory are used in different built shown below. They are organized by the Makefile
\begin{DoxyItemize}
\item eforth.\+html -\/ vanilla we\+Forth, one single-\/threaded H\+T\+ML. A good place to start.
\item ceforth.\+html -\/ we\+Forth, now with integrated editor, single-\/threaded.
\item weforth.\+html -\/ we\+Forth runs in a worker thread, can also do fancy G\+UI stuffs now Javascript module/files are included in the H\+T\+ML for added functionality 
\begin{DoxyPre}
       + weforth\_helper.js -\/ vocabulary lookup table
       + weforth\_worker.js -\/ worker thread proxy object
       + weforth\_sleep.js  -\/ sleep/delay support for async environment
       + weforth\_logo.js   -\/ Turtle Graphic implementation
       + weforth\_jolt.js   -\/ Jolt Physics Engine integration
       + file\_io.js        -\/ file IO support
       \end{DoxyPre}


The following Forth scripts under $\sim$/tests/forth are also included for G\+UI integration demo 
\begin{DoxyPre}
       + forth/logo.fs -\/ Turtle Graphics
       + forth/jolt.fs -\/ Jolt Physics Engine
       \end{DoxyPre}

\end{DoxyItemize}

\#\doxysubsection*{Bare-\/bone e\+Forth on Web}

\begin{DoxyVerb}make zero
Note: -O2 works OK, -O3 emscripten spits wrong code
\end{DoxyVerb}


try eforth.\+html \href{https://chochain.github.io/weForth/ref/eforth.html}{\texttt{ here}}

\doxysubsubsection*{Single W\+A\+SM file}

\begin{DoxyVerb}make one
\end{DoxyVerb}


try ceforth.\+html \href{https://chochain.github.io/weForth/ref/ceforth.html}{\texttt{ here}}

\doxysubsubsection*{Extra Web Worker thread}

\begin{DoxyVerb}make two
\end{DoxyVerb}


try weforth.\+html \href{https://chochain.github.io/weForth/ref/weforth.html}{\texttt{ here}}

\doxysubsection*{Run on your own box}

Server-\/side \begin{DoxyVerb}python3 -m http.server
\end{DoxyVerb}


Client-\/side Browser \begin{DoxyVerb}http://localhost:8000/tests/eforth.html, ceforth.html or weforth.html
\end{DoxyVerb}


\doxysubsection*{Javascript interface}

To communicate between Forth and Javascript engine, we\+Forth implemented a word \textquotesingle{}JS\textquotesingle{} and a function call\+\_\+js(). They utilize Emscripten E\+M\+\_\+\+JS macro that {\itshape post\+Message} from C++ backend-\/side to {\itshape onmessage} on browser-\/side. Depends on your need, handler can be very simple to complicated.

\doxysubsubsection*{in eforth.\+html and ceforth.\+html -\/ a simple (and dangerous) handler with the single-\/threaded demo}

\begin{DoxyVerb}this.onmessage = e=>{
    if (e.data[0]=='js') this.eval(e.data[1])
}

> 54321 s" alert('%d ... hello world!')" JS⏎
\end{DoxyVerb}




\doxysubsubsection*{weforth.\+html -\/ a more complex message dispatcher with the multi-\/threaded web worker demo}

\begin{DoxyVerb}const ex = (ops)=>Function(       ///< scope limiting eval
    `"use strict"; this.update('${ops}')`
).bind(logo)()
vm.onmessage = e=>{               /// * wait for worker's response
    let k = e.data[0], v = e.data[1]
    switch (k) {
    case 'cmd': to_txt(v);         break
    case 'dc' : show_dict(v);      break
    case 'us' : usr.innerHTML = v; break
    case 'ss' : ss.innerHTML  = v; break
    case 'mm' : mm.innerHTML  = v; ok=1; break
    case 'js' : ex(v);             break
    default: console.log('onmessage.error=>'+e)
    }
}

> s" forth/logo.fs" included⏎
> : seg FD 30 RT ;⏎
> : color 2* PC ;⏎
> : daz 100 0 do i color i seg loop ;⏎
> daz⏎
\end{DoxyVerb}




\doxysubsection*{D\+E\+B\+UG the W\+A\+SM file (dump all functions, check with wasm-\/objdump in W\+A\+BT kit)}

\begin{DoxyVerb}make debug
read tests/ceforth.wasm.txt (really long)
\end{DoxyVerb}


\doxysubsection*{Benchmark (on my aged I\+BM X230 w Intel \href{mailto:i5-3470@3.2GHz}{\texttt{ i5-\/3470@3.\+2\+G\+Hz}})}

Simple 10M tests \begin{DoxyVerb}: xx 9999 FOR 34 DROP NEXT ;⏎
: yy 999 FOR xx NEXT ;⏎
: zz MS NEGATE yy MS + ;⏎
zz⏎
\end{DoxyVerb}




Note\+:
\begin{DoxyItemize}
\item e\+Forth.\+js uses JS straight, can do floating-\/points
\item u\+Eforth v7 uses Asm.\+js, build Forth up with JS \char`\"{}assembly\char`\"{}.
\item we\+Forth v1 uses token indirected threaded
\item we\+Forth+switch(op), is 2x slower than just function pointers.
\item we\+Forth v1.\+2 without yield in \mbox{\hyperlink{ceforth_8cpp_ad846502b6abc77557b95ffb1d08699cc}{nest()}}, speeds up 3x.
\item W\+A\+SM -\/O3 =$>$ err functions (wa.$\ast$) not found
\item Fire\+Fox v122, is 2x faster than v120
\item Chrome is about 10\% slower than Fire\+Fox
\item we\+Forth 4.\+2 w float32-\/enabled, runs faster than int32, but why?
\item we\+Forth 4.\+2 w float32/real-\/time is slower due to message passing
\item we\+Forth 4.\+2 w float32/real-\/time is even slower without Web\+GL, why?
\end{DoxyItemize}

\doxysubsection*{T\+O\+DO}


\begin{DoxyItemize}
\item Physics Engine
\begin{DoxyItemize}
\item vehicle sim
\item C\+SG i.\+e. compound shape, \href{https://opencsg.org/}{\texttt{ Open\+C\+SG}}, \href{https://gts.sourceforge.net/}{\texttt{ G\+TS}}
\item review Jolt\+::\+Ref\+Target class (for ref counter, can apply to tensor\+Forth)
\end{DoxyItemize}
\item inter-\/\+VM communication
\begin{DoxyItemize}
\item A 16-\/node A\+ES cipher \href{https://www.highgo.ca/2019/08/08/the-difference-in-five-modes-in-the-aes-encryption-algorithm/}{\texttt{ A\+ES -\/ 5 different modes comparison}}
\item Cha\+Cha20 cipher. See JS cryptography libs \href{https://github.com/jedisct1/libsodium.js/}{\texttt{ libsodium.\+js}}
\end{DoxyItemize}
\item add network system (S\+D\+\_\+net)
\item review Web\+Serial
\item review wasmtime (C\+LI), perf+hotspot (profiling)
\item review Dragon\+Ruby/m\+Ruby (S\+DL) =$>$ 3D preferred
\item review R3, Forth C\+PU visualizer (S\+DL) =$>$ 3D preferred
\item review Gra\+F\+O\+R\+TH spec.
\begin{DoxyItemize}
\item File system (F\+S/\+Indexed\+DB)
\item Editor =$>$ Code\+Mirrow chosen
\item 2D graphic (S\+D\+L\+\_\+gfx, S\+D\+L\+\_\+image)
\item Character graphic (S\+D\+L\+\_\+ttf or H\+T\+M\+L5)
\item 3D graphic (GL) =$>$ Three.\+js Web\+GL
\item Audio (S\+D\+L\+\_\+media)
\end{DoxyItemize}
\item use W\+A\+SM stack as ss (brk, sbrk)
\item macro-\/assembler
\end{DoxyItemize}

\doxysubsection*{References}


\begin{DoxyItemize}
\item S\+D\+L2
\begin{DoxyItemize}
\item \href{https://lyceum-allotments.github.io/2016/06/emscripten-and-sdl-2-tutorial-part-1/}{\texttt{ Read first}}
\item \href{https://lazyfoo.net/tutorials/SDL/}{\texttt{ Lazy\+Foo for S\+D\+L2}}
\item \href{https://gist.github.com/raysan5/17392498d40e2cb281f5d09c0a4bf798}{\texttt{ raylib vs S\+D\+L2}}
\end{DoxyItemize}
\item Web\+GL
\begin{DoxyItemize}
\item \href{https://threejs.org/manual/\#en/fundamentals}{\texttt{ Three.\+js}}
\end{DoxyItemize}
\item Physics Engine
\begin{DoxyItemize}
\item \href{https://jrouwe.github.io/JoltPhysics/}{\texttt{ Jolt Physics}} 
\end{DoxyItemize}
\end{DoxyItemize}